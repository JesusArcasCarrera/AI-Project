{% extends "base_faceapi.html" %}

{% block body %}
<style>
    body {
        margin: 0;
        padding: 0;
        width: 100vw;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    canvas {
        position: absolute;
    }

    #outcome {
        display: none;
        visibility: hidden;
    }

    header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100px;
    }

    #video {
        min-width: 720px;
        min-height: 560px;
    }

    @media screen and (max-width: 600px) {
        #video {
            min-height: 375px;
            min-width: 500px;
            object-fit: cover;
        }

        body {
            background-color: #343a40 !important;
        }
    }
</style>
<video id="video" autoplay muted></video>
<div id="outcome">
    <h1> Results </h1>
    <div id="results"></div>
    <div id="classification"></div>
</div>
<script>
    // Modelo de TensorFlow.js
    var model;
    var classification = {
        0: 'with_mask',
        1: 'without_mask',
        2: 'wrong_mask'
    }
    var colors = {
        0: 'green',
        1: 'red',
        2: 'blue'
    }
    const video = document.getElementById('video');
    var displaySize;
    var predictions = []
    /*
        Carga la red de detección posteriormente inicializa el vídeo a través de startVideo()
        Activar la barra de carga
    */
    Promise.all([
        faceapi.nets.ssdMobilenetv1.loadFromUri("{{ url_for('static', filename='models/') }}")
    ]).then(startVideo)

    /*
        Inicializa el vídeo si está la cámara activa y lo añade como source al elemento <video> del DOM
    */
    async function startVideo() {

        model = await tf.loadLayersModel("{{ url_for('static', filename='models/tfjs/model.json') }}")
        // console.log(model.summary())

        // desactivar la barra de carga
        navigator.getUserMedia({
                video: {}
            },
            stream => video.srcObject = stream,
            err => console.error(err)
        )
    }

    video.addEventListener('play', async () => {
        const canvas = faceapi.createCanvasFromMedia(video)
        const ctx = canvas.getContext('2d')
        document.body.append(canvas)
        // Deberia actualizarse si cambia el tamaño de la pantalla
        const displaySize = {
            width: parseInt(window.getComputedStyle(video).width),
            height: parseInt(window.getComputedStyle(video).height)
        }
        faceapi.matchDimensions(canvas, displaySize)
        //if(mobile)
        const ssdMobilenetOptions = new faceapi.SsdMobilenetv1Options({
            minConfidence: 0.20,
            maxFaces: 20
        })

        setInterval(async () => {

            const detections = await faceapi.detectAllFaces(video, ssdMobilenetOptions)
            const resizedDetections = faceapi.resizeResults(detections, displaySize)

            ctx.clearRect(0, 0, canvas.width, canvas.height)
            await extractFaceFromBox(video, resizedDetections)
            resizedDetections.forEach(async (d, i) => {
                const drawBox = new faceapi.draw.DrawBox(d._box, {
                    boxColor: colors[predictions[i]],
                    label: classification[predictions[i]]
                })
                drawBox.draw(canvas)
            })
        }, 400)
    })


    async function extractFaceFromBox(inputImage, detections) {
    
        var faceImages = await faceapi.extractFaces(inputImage, detections)
        faceImages.forEach(async (img, i) => {
            var result = await model.predict(preprocess(img))
            data = result.dataSync()
            predictions[i] = data.indexOf(Math.max(...data))
        })
    }

    function preprocess(img) {
        const image = tf.browser.fromPixels(img);
        const resized = tf.image.resizeBilinear(image, [96, 96]).toFloat()
        const normalized = tf.div(resized, tf.scalar(255.0)) //tf.scalar(1.0).sub();
        return normalized.expandDims(0)
    }
</script>
{% endblock %}